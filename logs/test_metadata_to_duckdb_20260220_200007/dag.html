<!doctype html>
<html lang='pt-br'>
  <head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <title>DAG</title>
    <link rel='preconnect' href='https://fonts.googleapis.com'>
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
    <link href='https://fonts.googleapis.com/css2?family=Spectral:wght@400;600&family=IBM+Plex+Mono:wght@400;600&display=swap' rel='stylesheet'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css'>
    <style>
      body {
        margin: 0;
        background: radial-gradient(circle at top, #f8f4ed, #eee4d4 55%, #e0d6c6);
        font-family: "Spectral", serif;
        color: #1c1c1c;
      }
      .wrap {
        padding: 28px;
        display: grid;
        gap: 28px;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.5px;
        color: #222;
      }
      svg {
        background: #fffdf8;
        border: 2px solid #222;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        width: 100%;
        height: auto;
        max-width: 1200px;
        display: block;
      }
      .node {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .node:hover {
        filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.2));
      }
      .node.selected {
        stroke: #0b5ed7;
        stroke-width: 3px;
        filter: drop-shadow(0 10px 18px rgba(11, 94, 215, 0.35));
      }
      .node-label {
        pointer-events: none;
      }
      .graph-card {
        background: #fffaf1;
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      .cards {
        display: grid;
        gap: 18px;
      }
      .panel {
        background: #ffffff;
        border-radius: 18px;
        padding: 18px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
        min-height: 180px;
      }
      .panel-placeholder {
        color: #666;
        font-size: 14px;
      }
      .card {
        background: #ffffff;
        border-radius: 18px;
        padding: 18px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
      }
      .card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 12px;
      }
      .card h2 {
        margin: 0;
        font-size: 20px;
      }
      .meta {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .status {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: #e8e2d6;
      }
      .status-ok {
        background: #cfe8d7;
      }
      .status-fail {
        background: #f3c7c1;
      }
      .status-skip {
        background: #f2e5b4;
      }
      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: #f2f2f2;
        font-size: 12px;
      }
      .card-body {
        display: grid;
        gap: 16px;
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }
      .metrics div {
        background: #f8f4ec;
        border-radius: 12px;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }
      .metrics span {
        color: #555;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .metrics strong {
        font-size: 14px;
      }
      pre {
        margin: 0;
        padding: 12px;
        border-radius: 12px;
        background: #f7f4ec;
        overflow-x: auto;
        font-family: "IBM Plex Mono", monospace;
        font-size: 13px;
        line-height: 1.5;
      }
      .preview-table {
        display: none;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: #f7fbff;
      }
      .preview-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        font-family: "IBM Plex Mono", monospace;
      }
      .preview-table th,
      .preview-table td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        text-align: left;
        vertical-align: top;
      }
      .preview-table th {
        background: #e8f0ff;
        font-weight: 600;
      }
      pre.result-raw {
        background: #f1f6ff;
      }
      @media (min-width: 960px) {
        .card-body {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class='wrap'>
      <div>
        <h1>DAG Visualization</h1>
      </div>
      <section class='graph-card'>
        <svg viewBox='0 0 820 248' xmlns='http://www.w3.org/2000/svg'>
          <defs>
            <marker id='arrow' markerWidth='10' markerHeight='10' refX='8' refY='3' orient='auto'>
              <path d='M0,0 L0,6 L9,3 z' fill='#444' />
            </marker>
          </defs>
          <line x1='180' y1='64' x2='240' y2='64' stroke='#444' stroke-width='2'  marker-end='url(#arrow)' /><line x1='180' y1='64' x2='440' y2='64' stroke='#444' stroke-width='2'  marker-end='url(#arrow)' /><line x1='380' y1='64' x2='440' y2='64' stroke='#1f8a4c' stroke-width='2'  marker-end='url(#arrow)' /><line x1='180' y1='64' x2='440' y2='184' stroke='#444' stroke-width='2'  marker-end='url(#arrow)' /><line x1='380' y1='64' x2='440' y2='184' stroke='#c0392b' stroke-width='2' stroke-dasharray='6 4' marker-end='url(#arrow)' /><line x1='580' y1='184' x2='640' y2='64' stroke='#444' stroke-width='2'  marker-end='url(#arrow)' />
          <rect class='node' data-step='extract_users' x='40' y='40' width='140' height='48' rx='8' ry='8' fill='#f5f2e9' stroke='#222' stroke-width='2' /><text class='node-label' data-step='extract_users' x='110.0' y='69.0' text-anchor='middle' font-family='Georgia, serif' font-size='14' fill='#111'>extract_users</text><rect class='node' data-step='should_uppercase' x='240' y='40' width='140' height='48' rx='8' ry='8' fill='#f7efe0' stroke='#222' stroke-width='2' /><text class='node-label' data-step='should_uppercase' x='310.0' y='69.0' text-anchor='middle' font-family='Georgia, serif' font-size='14' fill='#111'>should_uppercase</text><rect class='node' data-step='uppercase_names' x='440' y='40' width='140' height='48' rx='8' ry='8' fill='#f5f2e9' stroke='#222' stroke-width='2' /><text class='node-label' data-step='uppercase_names' x='510.0' y='69.0' text-anchor='middle' font-family='Georgia, serif' font-size='14' fill='#111'>uppercase_names</text><rect class='node' data-step='keep_original' x='440' y='160' width='140' height='48' rx='8' ry='8' fill='#f5f2e9' stroke='#222' stroke-width='2' /><text class='node-label' data-step='keep_original' x='510.0' y='189.0' text-anchor='middle' font-family='Georgia, serif' font-size='14' fill='#111'>keep_original</text><rect class='node' data-step='load' x='640' y='40' width='140' height='48' rx='8' ry='8' fill='#f5f2e9' stroke='#222' stroke-width='2' /><text class='node-label' data-step='load' x='710.0' y='69.0' text-anchor='middle' font-family='Georgia, serif' font-size='14' fill='#111'>load</text>
        </svg>
      </section>
      <section class='panel' id='detail-panel'>
        <div class='panel-placeholder'>Click a step to view details.</div>
        
        <article class='card' id='step-extract_users' hidden>
          <header>
            <div>
              <h2>extract_users</h2>
              <div class='meta'>
                <span class='status status-ok'>done</span>
                <span class='pill'>step</span>
                <span class='pill'>enabled</span>
                <span class='pill'>0.010 ms</span>
                <span class='pill'>in 0 lines</span>
                <span class='pill'>out 3 lines</span>
              </div>
            </div>
          </header>
          <div class='metrics'>
            <div><span>Input lines</span><strong>0</strong></div>
            <div><span>Output lines</span><strong>3</strong></div>
          </div>
          <div class='card-body'>
            <div>
              <h3>Code</h3>
              <pre><code class='language-python'>    @dag.step()
    def extract_users():
        return [
            {&quot;id&quot;: 1, &quot;name&quot;: &quot;ana&quot;},
            {&quot;id&quot;: 2, &quot;name&quot;: &quot;bruno&quot;},
            {&quot;id&quot;: 3, &quot;name&quot;: &quot;carla&quot;},
        ]</code></pre>
            </div>
            <div>
              <h3>Preview</h3>
              <div class='preview-table' data-empty='true'></div>
              <pre class='result-raw'>[{&quot;id&quot;: 1, &quot;name&quot;: &quot;ana&quot;}, {&quot;id&quot;: 2, &quot;name&quot;: &quot;bruno&quot;}, {&quot;id&quot;: 3, &quot;name&quot;: &quot;carla&quot;}]</pre>
            </div>
          </div>
        </article>

        <article class='card' id='step-should_uppercase' hidden>
          <header>
            <div>
              <h2>should_uppercase</h2>
              <div class='meta'>
                <span class='status status-ok'>done</span>
                <span class='pill'>branch</span>
                <span class='pill'>enabled</span>
                <span class='pill'>0.011 ms</span>
                <span class='pill'>in 3 lines</span>
                <span class='pill'>out 1 lines</span>
              </div>
            </div>
          </header>
          <div class='metrics'>
            <div><span>Input lines</span><strong>3</strong></div>
            <div><span>Output lines</span><strong>1</strong></div>
          </div>
          <div class='card-body'>
            <div>
              <h3>Code</h3>
              <pre><code class='language-python'>    @dag.branch(depends_on=[extract_users])
    def should_uppercase() -&gt; bool:
        return False</code></pre>
            </div>
            <div>
              <h3>Preview</h3>
              <div class='preview-table' data-empty='true'></div>
              <pre class='result-raw'>false</pre>
            </div>
          </div>
        </article>

        <article class='card' id='step-uppercase_names' hidden>
          <header>
            <div>
              <h2>uppercase_names</h2>
              <div class='meta'>
                <span class='status status-skip'>skipped</span>
                <span class='pill'>step</span>
                <span class='pill'>enabled</span>
                <span class='pill'>0.000 ms</span>
                <span class='pill'>in 0 lines</span>
                <span class='pill'>out 0 lines</span>
              </div>
            </div>
          </header>
          <div class='metrics'>
            <div><span>Input lines</span><strong>0</strong></div>
            <div><span>Output lines</span><strong>0</strong></div>
          </div>
          <div class='card-body'>
            <div>
              <h3>Code</h3>
              <pre><code class='language-python'>    @dag.step(depends_on=[extract_users], when=should_uppercase, condition=True)
    def uppercase_names(results):
        return [{&quot;id&quot;: row[&quot;id&quot;], &quot;name&quot;: row[&quot;name&quot;].upper()} for row in results[&quot;extract_users&quot;]]</code></pre>
            </div>
            <div>
              <h3>Preview</h3>
              <div class='preview-table' data-empty='true'></div>
              <pre class='result-raw'>No result</pre>
            </div>
          </div>
        </article>

        <article class='card' id='step-keep_original' hidden>
          <header>
            <div>
              <h2>keep_original</h2>
              <div class='meta'>
                <span class='status status-ok'>done</span>
                <span class='pill'>step</span>
                <span class='pill'>enabled</span>
                <span class='pill'>0.004 ms</span>
                <span class='pill'>in 4 lines</span>
                <span class='pill'>out 3 lines</span>
              </div>
            </div>
          </header>
          <div class='metrics'>
            <div><span>Input lines</span><strong>4</strong></div>
            <div><span>Output lines</span><strong>3</strong></div>
          </div>
          <div class='card-body'>
            <div>
              <h3>Code</h3>
              <pre><code class='language-python'>    @dag.step(depends_on=[extract_users], when=should_uppercase, condition=False)
    def keep_original(results):
        return results[&quot;extract_users&quot;]</code></pre>
            </div>
            <div>
              <h3>Preview</h3>
              <div class='preview-table' data-empty='true'></div>
              <pre class='result-raw'>[{&quot;id&quot;: 1, &quot;name&quot;: &quot;ana&quot;}, {&quot;id&quot;: 2, &quot;name&quot;: &quot;bruno&quot;}, {&quot;id&quot;: 3, &quot;name&quot;: &quot;carla&quot;}]</pre>
            </div>
          </div>
        </article>

        <article class='card' id='step-load' hidden>
          <header>
            <div>
              <h2>load</h2>
              <div class='meta'>
                <span class='status status-ok'>done</span>
                <span class='pill'>step</span>
                <span class='pill'>enabled</span>
                <span class='pill'>0.003 ms</span>
                <span class='pill'>in 3 lines</span>
                <span class='pill'>out 1 lines</span>
              </div>
            </div>
          </header>
          <div class='metrics'>
            <div><span>Input lines</span><strong>3</strong></div>
            <div><span>Output lines</span><strong>1</strong></div>
          </div>
          <div class='card-body'>
            <div>
              <h3>Code</h3>
              <pre><code class='language-python'>    @dag.step(depends_on=[keep_original])
    def load(results):
        rows = results[&quot;keep_original&quot;]
        return {&quot;loaded_rows&quot;: len(rows)}</code></pre>
            </div>
            <div>
              <h3>Preview</h3>
              <div class='preview-table' data-empty='true'></div>
              <pre class='result-raw'>{&quot;loaded_rows&quot;: 3}</pre>
            </div>
          </div>
        </article>

      </section>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'></script>
    <script>
      const panel = document.getElementById('detail-panel');
      const cards = panel.querySelectorAll('.card');
      const esc = (value) => String(value)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');
      const showCard = (name) => {
        cards.forEach(card => {
          card.hidden = card.id !== `step-${name}`;
        });
        document.querySelectorAll('.node').forEach(node => {
          node.classList.toggle('selected', node.getAttribute('data-step') === name);
        });
        const placeholder = panel.querySelector('.panel-placeholder');
        if (placeholder) placeholder.style.display = 'none';
        const card = panel.querySelector(`#step-${name}`);
        if (card) {
          const raw = card.querySelector('.result-raw');
          const tableWrap = card.querySelector('.preview-table');
          if (raw && tableWrap) {
            const text = raw.textContent.trim();
            let parsed = null;
            try {
              parsed = JSON.parse(text);
            } catch (_) {
              parsed = null;
            }
            if (parsed !== null && typeof parsed === 'object') {
              const rows = Array.isArray(parsed) ? parsed : [parsed];
              const sample = rows;
              const keys = Array.isArray(parsed)
                ? Array.from(new Set(sample.flatMap(row => Object.keys(row || {}))))
                : Object.keys(parsed || {});
              if (!keys.length || !sample.length) {
                tableWrap.style.display = 'none';
                raw.style.display = 'block';
              } else {
                const header = `<tr>${keys.map(k => `<th>${esc(k)}</th>`).join('')}</tr>`;
                const body = sample.map(row => {
                  const cells = keys.map(k => {
                    const value = row && typeof row === 'object' ? row[k] : row;
                    const rendered = typeof value === 'object' ? JSON.stringify(value) : value;
                    return `<td>${esc(rendered)}</td>`;
                  }).join('');
                  return `<tr>${cells}</tr>`;
                }).join('');
                tableWrap.innerHTML = `<table>${header}${body}</table>`;
                tableWrap.style.display = 'block';
                raw.style.display = 'none';
              }
            } else {
              tableWrap.style.display = 'none';
              raw.style.display = 'block';
            }
          }
        }
        hljs.highlightAll();
      };
      document.querySelectorAll('.node, .node-label').forEach(node => {
        node.addEventListener('click', () => {
          const name = node.getAttribute('data-step');
          if (name) showCard(name);
        });
      });
    </script>
  </body>
</html>
